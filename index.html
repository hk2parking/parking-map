<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>太白区 東郡山 2丁目 月極駐車場</title>
  <meta name="description" content="仙台市太白区東郡山2丁目の月極駐車場（22区画）。">
  <style>
    body { font-family: sans-serif; margin: 12px; }
    #map { width: 100%; height: 640px; border: 1px solid #ddd; }
  </style>
</head>
<body>
<h1>太白区 東郡山2丁目 月極駐車場</h1>
<div id="map"></div>

<script>
async function initMap() {
  const map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 38.221605, lng: 140.900496 },
    zoom: 15,
    mapTypeId: 'roadmap'
  });
  console.log('map initialized');

  const infoWindow = new google.maps.InfoWindow();
  const bounds = new google.maps.LatLngBounds();
  let markerCount = 0;

  try {
    const res = await fetch('parkings.csv');
    if (!res.ok) throw new Error('parkings.csv が読み込めません: ' + res.status);
    const text = await res.text();
    console.log('parkings.csv loaded, length:', text.length);

    const lines = text.trim().split('\n');
    if (lines.length <= 1) {
      console.warn('CSV にデータがありません（ヘッダーのみ）');
    }

    // マーカー追加ループ
    for (let i = 1; i < lines.length; i++) {
      const raw = lines[i].trim();
      if (!raw) continue;
      // 簡易CSVパース（カンマがデータに含まれる場合は PapaParse の導入を検討）
      const cols = raw.split(',');
      const name = (cols[0] || '').trim();
      const lat = parseFloat((cols[1] || '').trim());
      const lng = parseFloat((cols[2] || '').trim());
      const url = (cols[3] || '#').trim();
      const status = (cols[4] || '').trim().toLowerCase();

      if (!name) console.warn('名前が空の行:', i, raw);
      if (isNaN(lat) || isNaN(lng)) {
        console.warn('無効な緯度経度（スキップ）:', i, raw);
        continue;
      }

      markerCount++;
      bounds.extend({ lat, lng });

      const pinColor = status === 'taken' ? 'red' : (status === 'free' ? 'green' : 'blue');
      const svgMarker = {
        path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z M12 11.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z",
        fillColor: pinColor,
        fillOpacity: 1,
        strokeWeight: 0,
        scale: 1.6
      };

      const marker = new google.maps.Marker({
        position: { lat, lng },
        map,
        title: name || ('NoName-' + i),
        icon: svgMarker
      });

      marker.addListener('click', () => {
        infoWindow.setContent(`<strong>${escapeHtml(name)}</strong><br>` +
                              (url && url !== '#' ? `<a href="${escapeHtml(url)}" target="_blank">詳細を見る</a>` : ''));
        infoWindow.open(map, marker);
        // クリックで地図をセンターに移動（必要ならコメントアウト）
        map.panTo(marker.getPosition());
      });

      console.log('marker added:', markerCount, name, lat, lng, status);
    } // for

    console.log('total markers:', markerCount);

    // ★ここがポイント：マーカー数で制御する（boundsの等値判定は使わない）
    if (markerCount === 0) {
      console.warn('マーカーが0件です。中心はデフォルトのまま。');
    } else if (markerCount === 1) {
      // マーカーが1件のときは center + 固定ズーム
      const center = bounds.getCenter();
      console.log('single marker center:', center.toString());
      map.setCenter(center);
      map.setZoom(17); // 必要に応じて数字を調整
      // 少し遅延させてから再パンすると安定する環境もあるので任意で:
      // setTimeout(()=> map.panTo(center), 250);
    } else {
      // マーカーが2件以上のときは fitBounds
      map.fitBounds(bounds);
    }

  } catch (err) {
    console.error('initMap error:', err);
    alert('地図データの読み込みでエラーが発生しました: ' + err.message);
  }
}

// HTMLエスケープ
function escapeHtml(str) {
  if (!str) return '';
  return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
            .replaceAll('"','&quot;').replaceAll("'",'&#39;');
}
</script>

<!-- APIキーはすでに設定済みとのこと。なければ YOUR_API_KEY に差し替え -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvMlZ7Q2VqRug6A5k8dCNax7ODFDiBRJc&callback=initMap">
</script>

</body>
</html>
